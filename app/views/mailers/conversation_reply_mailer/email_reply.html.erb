<% if @message.content %>
  <div>
    <%= ChatwootMarkdownRenderer.new(@message.content).render_message %>
  </div>
<% end %>
<% if @message.attachments %>
  <div style="margin: 10px 0;">
    <% @message.attachments.each do |attachment| %>
      <div style="padding: 8px 0;">
        attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]
      </div>
    <% end %>
  </div>
<% end %>

<% if @conversation.inbox&.inbox_type == 'Email' && @previous_messages.present? %>
  <hr style="border: 0; border-top: 1px solid #ddd; margin: 0px 0;">
  <div style="color: #666; font-size: 14px; font-style: italic; margin-bottom: 10px;">
  </div>
  <div>
    <div style="color: #666; font-style: italic;">
      <% first_message = @previous_messages.first %>
      <% sender_name = first_message.sender&.try(:available_name) || first_message.sender&.name || 'Unknown' %>
      <% sender_email = first_message.content_attributes&.dig(:email, :from)&.first || first_message.sender&.email || get_sender_email(first_message) %>
      <% message_date = first_message.created_at.strftime("%a, %b %-d, %Y at %-l:%M %p") %>
      On <%= message_date %>, <%= sender_name %> &lt;<%= sender_email %>&gt; wrote:
    </div>
    <br>
    <%= first_message.content %>
    <% if first_message.attachments.present? %>
      <% first_message.attachments.each do |attachment| %>
        <div>attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]</div>
      <% end %>
    <% end %>

    <% @previous_messages.drop(1).each do |prev_message| %>
      <div style="margin-left: 20px;">
        <div style="color: #666; font-style: italic;">
          <% sender_name = prev_message.sender&.try(:available_name) || prev_message.sender&.name || 'Unknown' %>
          <% sender_email = prev_message.content_attributes&.dig(:email, :from)&.first || prev_message.sender&.email || get_sender_email(prev_message) %>
          <% message_date = prev_message.created_at.strftime("%a, %b %-d, %Y at %-l:%M %p") %>
          On <%= message_date %>, <%= sender_name %> &lt;<%= sender_email %>&gt; wrote:
        </div>
        <br>
        <%= prev_message.content %>
        <% if prev_message.attachments.present? %>
          <% prev_message.attachments.each do |attachment| %>
            <div>attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]</div>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
