<% if @message.content %>
  <%= ChatwootMarkdownRenderer.new(@message.content).render_message %>
<% end %>
<% if @message.attachments %>
  <% @message.attachments.each do |attachment| %>
    attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]
  <% end %>
<% end %>

<% if @conversation.inbox&.inbox_type == 'Email' && @previous_messages.present? %>
  <br>
  <!-- Simple blockquote format for proper email client compatibility -->
  <blockquote style="border-left: 1px solid #ccc; margin-left: 0.8ex; padding-left: 1ex;">
    <div style="color: #666;">
      <% first_message = @previous_messages.first %>
      <% sender_name = first_message.sender&.try(:available_name) || first_message.sender&.name || 'Unknown' %>
      <% sender_email = get_sender_email(first_message) %>
      <% message_date = first_message.created_at.strftime("%a, %b %-d, %Y at %-l:%M %p") %>
      On <%= message_date %>, <%= sender_name %> &lt;<%= sender_email %>&gt; wrote:
    </div>
    <br>
    <%= first_message.content %>
    <% if first_message.attachments.present? %>
      <% first_message.attachments.each do |attachment| %>
        <div>attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]</div>
      <% end %>
    <% end %>
    
    <% @previous_messages.drop(1).each do |prev_message| %>
      <blockquote style="border-left: 1px solid #ccc; margin-left: 0.8ex; padding-left: 1ex;">
        <div style="color: #666;">
          <% sender_name = prev_message.sender&.try(:available_name) || prev_message.sender&.name || 'Unknown' %>
          <% sender_email = get_sender_email(prev_message) %>
          <% message_date = prev_message.created_at.strftime("%a, %b %-d, %Y at %-l:%M %p") %>
          On <%= message_date %>, <%= sender_name %> &lt;<%= sender_email %>&gt; wrote:
        </div>
        <br>
        <%= prev_message.content %>
        <% if prev_message.attachments.present? %>
          <% prev_message.attachments.each do |attachment| %>
            <div>attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]</div>
          <% end %>
        <% end %>
      </blockquote>
    <% end %>
  </blockquote>
<% end %>
