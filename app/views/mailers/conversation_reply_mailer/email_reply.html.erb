<% if @message.content %>
  <%= ChatwootMarkdownRenderer.new(@message.content).render_message %>
<% end %>
<% if @message.attachments %>
  <% @message.attachments.each do |attachment| %>
    attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]
  <% end %>
<% end %>

<% if @conversation.inbox&.inbox_type == 'Email' && @previous_messages.present? %>
  <br>
  <!-- 
    Gmail-specific format for collapsible quoted text
    NOTE: Do not increase the message limit beyond 5 in the controller.
    Increasing the limit can cause issues with email delivery and proper quoted format.
  -->
  <div class="gmail_extra">
    <div class="gmail_quote">
      <div class="gmail_attr">
        <% first_message = @previous_messages.first %>
        <% sender_name = first_message.sender&.try(:available_name) || first_message.sender&.name || 'Unknown' %>
        <% channel_email = @channel.try(:email) || @inbox.email_address || @account.support_email %>
        <% message_date = first_message.created_at.strftime("%a, %b %-d, %Y at %-l:%M %p") %>
        On <%= message_date %>, <%= sender_name %> &lt;<%= channel_email %>&gt; wrote:<br>
      </div>
      <blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">
        <%= first_message.content %>
        <% if first_message.attachments.present? %>
          <% first_message.attachments.each do |attachment| %>
            <div>attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]</div>
          <% end %>
        <% end %>
        
        <% @previous_messages.drop(1).each do |prev_message| %>
          <div class="gmail_attr">
            <% sender_name = prev_message.sender&.try(:available_name) || prev_message.sender&.name || 'Unknown' %>
            <% message_date = prev_message.created_at.strftime("%a, %b %-d, %Y at %-l:%M %p") %>
            <br>On <%= message_date %>, <%= sender_name %> &lt;<%= channel_email %>&gt; wrote:<br>
          </div>
          <blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex">
            <%= prev_message.content %>
            <% if prev_message.attachments.present? %>
              <% prev_message.attachments.each do |attachment| %>
                <div>attachment [<a href="<%= attachment.file_url %>" _target="blank">click here to view</a>]</div>
              <% end %>
            <% end %>
          </blockquote>
        <% end %>
      </blockquote>
    </div>
  </div>
<% end %>
